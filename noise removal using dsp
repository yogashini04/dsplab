#include <stdio.h>
#include "c6713dsk.h"
#include "master.h"
#include "aic23cfg.h"
#include "dsk6713_aic23.h"
#define FiltLen 47
#define SINE_TABLE_SIZE 48
float PrNoise
[600]={0.3509,0.1118,0.3631,0.2673,0.2826,0.1909,0.2901,0.1378,0.1270,0.1798,
0.2925,0.3730,0.1307,0.1380,0.2859,0.1738,0.3278,0.0355,0.3177,0.2905,
0.1473,0.2380,0.2112,0.2662,0.3228,0.0264,0.2991,0.3027,0.1220,0.1676,
0.2360,0.2942,0.3058,0.3013,0.1423,0.1478,0.3479,0.2017,0.3278,0.1164,
0.2747,0.2752,0.4239,0.0666,0.2130,0.2124,0.0124,0.3306,0.3134,0.1420,
0.2837,0.0446,0.2438,0.1069,0.1902,0.3497,0.0962,0.1404,0.2046,0.1419,
0.3231,0.3962,0.0549,0.0875,0.2742,0.1418,0.3797,0.3756,0.2441,0.3271,
0.1456,0.2332,0.3789,0.2250,0.3798,0.3153,0.2295,0.2950,0.3924,0.0982,
0.1493,0.3649,0.1159,0.2095,0.3088,0.3656,0.2539,0.0606,0.0548,0.2847,
0.2610,0.4005,0.2985,0.2459,0.1789,0.0824,0.3774,0.2256,0.0309,0.2949,
0.2133,0.0136,0.3288,0.0923,0.0491,0.0178,0.1205,0.1107,0.3042,0.0761,
0.1512,0.1302,0.3434,0.1384,0.2454,0.1873,0.2804,0.0407,0.4164,0.3858,
0.0678,0.2275,0.1430,0.2304,0.0500,0.1793,0.1887,0.2067,0.1776,0.0374,
0.2449,0.2093,0.0772,0.1982,0.1787,0.2021,0.2916,0.2557,0.3304,0.0184,
0.0892,0.1823,0.3762,0.2984,0.1576,0.1120,0.0088,0.3026,0.2274,0.1223,
0.2151,0.1131,0.3248,0.1441,0.3475,-0.0471,0.2749,0.1925,0.1708,0.2431,
0.2975,0.0634,0.3891,0.0372,0.1486,0.0943,0.3835,0.0355,0.2320,0.2466,
0.2428,0.3175,-0.0105,0.2891,0.1764,0.2621,0.0814,0.2239,0.3074,0.4196,
0.2065,0.0613,0.0321,0.2495,0.3044,0.2513,0.1193,0.3635,0.2031,0.3801,
0.0303,0.0733,0.3001,0.3507,0.2985,0.1186,0.0656,0.3612,0.3397,0.1294,
0.1102,0.1194,0.3025,0.2892,0.1845,0.1956,0.1073,0.2981,0.3682,0.2311,
0.2244,0.2099,0.0990,0.2220,0.2894,0.2813,0.2316,0.0653,0.2872,0.1048,

0.1335,0.1639,0.1335,0.2752,0.0262,0.2958,0.2226,0.2916,0.1142,0.2017,
0.3252,0.2093,0.1280,0.4335,0.0627,0.1850,0.4388,0.1821,0.1451,0.0544,
0.3462,0.0154,0.0822,0.3031,0.1478,0.2130,0.2230,0.2897,0.0397,0.2436,
0.0428,0.3551,0.1458,0.3382,0.0957,0.2303,0.3804,0.0262,0.0356,0.0130,
0.2607,0.2102,-0.0020,0.2581,0.1933,-0.0047,0.0244,0.0922,0.3805,0.1092,
0.1670,0.1447,0.0477,0.3077,0.2124,0.2124,0.1879,0.1623,0.1219,0.2904,

0.0953,0.1132,0.0502,0.4002,0.3765,0.0096,0.1440,0.2291,0.1027,0.3114,
0.2580,0.2089,0.1434,0.3168,0.3503,0.2551,0.1064,0.3127,0.0588,0.1926,
0.3867,0.1418,0.1538,0.4241,0.0659,0.1438,0.2286,0.0508,0.2072,0.2740,
0.1688,0.2416,0.0827,0.2314,0.3496,0.1934,0.3886,0.0894,0.0704,0.1493,
0.1843,0.1859,0.1252,0.2559,0.0035,0.1217,0.0717,0.0912,0.0251,0.2405,
0.1436,0.1074,0.0493,0.1552,0.2456,0.3565,-0.0167,0.3025,-0.0187,0.2772,
0.2816,0.3582,0.0750,0.2422,0.2169,0.1210,0.2634,0.2424,0.0600,0.1631,
0.3293,0.1383,0.2371,0.1551,0.0338,0.1593,0.3720,0.1812,0.0607,0.1999,
0.1206,0.2411,0.1635,0.2727,0.2958,0.0758,0.0701,0.3565,0.2880,0.0363,
0.3726,0.2002,0.2003,0.2127,0.2768,0.3146,0.1400,0.0291,0.2936,0.1341,
0.3375,0.1544,0.3321,0.0716,0.0532,0.3473,0.0176,0.2671,0.2772,0.1617,
0.1264,0.3688,0.1475,0.1768,0.0764,0.1556,0.1539,0.3684,0.0979,0.1012,
0.1261,0.2401,0.0153,0.3234,0.0373,0.2052,0.0465,0.3405,0.3056,0.0901,
0.2585,0.1746,0.2905,0.1795,0.3366,0.1744,0.1618,0.2372,0.1421,0.3937,
0.1927,0.0760,0.1248,0.2367,0.1159,0.0431,0.3350,0.2452,0.1800,0.1234,
0.1133,0.2164,0.1742,0.2783,0.0053,0.3180,0.2518,0.0386,0.3270,0.0609,
0.2273,0.2060,0.0477,0.0029,0.3182,0.3218,0.1980,0.0483,0.2532,0.0704,
0.2688,0.1805,0.0634,0.3304,0.2816,0.3470,0.0396,0.0822,0.3077,0.2812,
0.2906,0.1659,0.1466,0.2278,0.3560,0.3095,0.2671,0.1798,0.3339,0.1612,
0.1967,0.2755,0.2225,0.2483,0.3013,0.2941,0.0201,0.0807,0.1395,0.2114,
0.0911,0.2137,0.1130,0.1435,0.2817,0.0310,0.0678,0.3107,0.1429,0.0814,
0.2429,0.3712,0.1587,0.2622,0.2169,0.1503,0.1834,0.3897,0.0846,0.1703,
0.2341,0.2631,0.3412,0.1344,0.0903,0.1993,0.0939,0.2847,0.1697,0.2312,
0.2761,0.1753,0.1190,0.0868,0.3864,0.0813,0.3023,0.2145,0.2764,0.3148,
0.0086,0.1329,0.3952,0.2684,0.3843,0.2181,0.0226,0.2681,0.1080,0.2249,
0.2832,0.2395,0.2193,0.1590,0.0663,0.1474,-0.0163,0.2260,0.3727,0.0303,
0.0235,0.3627,0.1062,0.0084,0.3246,0.0568,0.3485,0.0407,0.1353,0.2338,
0.2315,0.2545,0.2482,0.1510,0.0363,0.2882,0.0925,0.2603,0.3444,0.0445,
0.4034,0.0162,0.3319,0.3212,0.0066,0.2010,0.3604,0.1120,0.3155,0.2390,
0.3231,0.3301,0.0269,0.1138,0.2520,0.1875,0.3778,0.2939,0.2133,0.1170,
0.0977,0.3524,0.1664,0.3211,0.0252,0.3361,0.0023,0.3513,0.3686,0.2151,
0.0581,0.0777,0.1664,0.3211,0.0252,0.3361,0.0023,0.3513,0.3686,0.2151};
Note: // Generate the Noise from the Noise table from the matlab using rand()
function//

float RemNoise[47]={ -2.181030629062908e-002,8.917428211564256e-
003,1.182863130963947e-002, 1.428453375748106e-002,1.403350814552515e

,

002,1.039856067649067e-002,5.093274200275827e-003, 1.421581262318843e-
003,2.515430936577368e-003,9.363053213111126e-003,1.949152112446623e-002,

2.722897698684972e-002,2.579943237700517e-002,1.050645191333675e-002,
1.832163998604397e-002, -5.406194181033640e-002,-8.514869723584616e-002,
9.887618777194764e-002,-8.633153232820758e-002, -4.651515024517261e
002,1.217011610629542e-002,7.394838432088444e-002,1.206802616409422e-001,
1.380624377729094e-001,1.206802616409422e-001,7.394838432088444e
002,1.217011610629542e-002, -4.651515024517261e-002,-8.633153232820758e-002,-
9.887618777194764e-002,-8.514869723584616e-002, -5.406194181033640e-002,-

1.832163998604397e-002,1.050645191333675e-002,2.579943237700517e-002,
2.722897698684972e-002,1.949152112446623e-002,9.363053213111126e
003,2.515430936577368e-003, 1.421581262318843e-003,5.093274200275827e

003,1.039856067649067e-002,1.403350814552515e-002, 1.428453375748106e-
002,1.182863130963947e-002,8.917428211564256e-003,-2.181030629062908e-002};

DSK6713_AIC23_Config config = { \
0x0017, /* 0 DSK6713_AIC23_LEFTINVOL Left line input channel volume */ \
0x0017, /* 1 DSK6713_AIC23_RIGHTINVOL Right line input channel volume */\
0x00d8, /* 2 DSK6713_AIC23_LEFTHPVOL Left channel headphone volume */ \
0x00d8, /* 3 DSK6713_AIC23_RIGHTHPVOL Right channel headphone volume */ \
0x0010, /* 4 DSK6713_AIC23_ANAPATH Analog audio path control */ \
0x0000, /* 5 DSK6713_AIC23_DIGPATH Digital audio path control */ \
0x0000, /* 6 DSK6713_AIC23_POWERDOWN Power down control */ \
0x0043, /* 7 DSK6713_AIC23_DIGIF Digital audio interface format */ \
0x008c, /* 8 DSK6713_AIC23_SAMPLERATE Sample rate control */ \
0x0001 /* 9 DSK6713_AIC23_DIGACT Digital interface activation */ \
};
DSK6713_AIC23_CodecHandle hCodec;
Int32 InitWait =1;
Int32 data;
float in_buffer[100];
float InSigBuffer[600];
float NoiseBuffer[600];
float CorrSigBuffer[600];
float RecovSigBuffer[600];
int LogIndex =0;
main(){
int i;
LED=0x0;
CSL_init();
for( i = 0 ; i < 100; i++ ) in_buffer[i]=0.0;
hCodec = DSK6713_AIC23_openCodec(0, &config);
IRQ_globalEnable();
IRQ_enable(IRQ_EVT_RINT1);
IRQ_enable(IRQ_EVT_XINT1);
}
void led(){
static int cc = 1;
LED = cc;
if (cc == 0x03) cc = 0x05;
else if (cc == 0x05) cc = 0x06;

else if (cc == 0x06) cc = 0x03;
else cc = 0x03;
}
setpll200M(){
}
void read(){
int i = 0;
float result;
float InData;
float InNoise;
float InCorrup;
static int NoiseIndex=0;
data=MCBSP_read(DSK6713_AIC23_DATAHANDLE);
if(data>=32768) data= data|0xffff0000;
InData = (Int32) (data)/16;
InData=data;
InNoise = PrNoise[NoiseIndex++]*4096 - 1024;
if (NoiseIndex == 600)
NoiseIndex = 0;
InCorrup = InData + InNoise;
for( i = 0; i <= (FiltLen-2); i++) in_buffer[i] = in_buffer[i+1];
in_buffer[FiltLen-1]=InCorrup;
result = 0;
for( i = 0 ; i <= (FiltLen-1); i++ ) result += RemNoise[i] * in_buffer[i];
data = (Int32)(result*512);
InSigBuffer[LogIndex]= InData;
NoiseBuffer[LogIndex]= InNoise ;
CorrSigBuffer[LogIndex]= InCorrup;
RecovSigBuffer[LogIndex] = (float)data;
LogIndex++;
if (LogIndex == 600)
LogIndex =0;

}
void write(){
if (InitWait<1000){
InitWait++;
MCBSP_write(DSK6713_AIC23_DATAHANDLE, 0);
MCBSP_write(DSK6713_AIC23_DATAHANDLE, 0);
}
else{

}
}

MCBSP_write(DSK6713_AIC23_DATAHANDLE, data);
MCBSP_write(DSK6713_AIC23_DATAHANDLE, data);
